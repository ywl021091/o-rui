<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>修改用户信息</title>
<link rel="stylesheet" href="../../static/css/bootstrap.min.css">
<link rel="stylesheet" href="../../../static/css/font-awesome-4.7.0/css/font-awesome.min.css">
<!-- 时间选择器样式 -->
<link rel="stylesheet" href="../../../static/css/bootstrap-datetimepicker.min.css">
<link rel="stylesheet" href="../../../static/css/html.css">
<style>
#formwrapper {
	width: 450px;
	margin: 15px auto;
	padding: 20px;
	text-align: left;
	border: 1px #1E7ACE solid;
}

fieldset {
	padding: 10px;
	margin-top: 5px;
	border: 1px solid #1E7ACE;
	background: #fff;
}

fieldset legend {
	color: #1E7ACE;
	font-weight: bold;
	padding: 3px 20px 3px 20px;
	border: 1px solid #1E7ACE;
	background: #fff;
}

.enter {
	text-align: center;
}

.alert alert-warning {
	float: right;
}
</style>
</head>
<body>
	<div th:replace="fragment/public :: #public_header"></div>
	<div th:replace="fragment/public :: #public_time"></div>
	<div class="publicBody">
		<div th:replace="fragment/public :: #public_left"></div>
		<div class="publicRight">
			<!-- 面包屑导航栏 -->
			<div>
				<nav class="breadcrumb">
					<a class="breadcrumb-item">基础信息</a> <a class="breadcrumb-item">用户管理</a>
					<a class="breadcrumb-item active">用户修改</a>
				</nav>
			</div>
			<div id="formwrapper">

				<!-- 修改样式 在CSS里定义 -->
				<form id="formup" >
					<fieldset>
						<legend>修改用户信息</legend>
						<div class="input-group mb-3">
							<div class="input-group-prepend">
								<span class="input-group-text">编号</span>
							</div>
							<input class="form-control" name="sysuserid" id="sysuserid"
								readonly="readonly">
						</div>
						<div class="input-group mb-3">
							<div class="input-group-prepend">
								<span class="input-group-text">*登录名</span>
							</div>
							<input class="form-control" id="usernum" name="usernum" maxlength="20" onblur="usernum_uq_null()">
						</div>
						<div class="alert alert-warning" id="usernumAlert"
							style="display: none">
							<strong>提示！</strong>此用户名被占用或此选项为空。
						</div>

						<div class="input-group mb-3">
							<div class="input-group-prepend">
								<span class="input-group-text">*姓名</span>
							</div>
							<input type="text" class="form-control" id="name" name="name" maxlength="10" onblur="name_unnull()">
						</div>
						<div class="alert alert-warning" id="nameAlert"
							style="display: none">
							<strong>提示！</strong>此选项不能为空。
						</div>
						<div class="input-group mb-3">
							<div class="input-group-prepend">
								<span class="input-group-text">性别</span>
							</div>
							&nbsp;&nbsp;&nbsp;&nbsp;
							<div class="input-group-text">
								<input name="sex" type="radio" value="男" id="men" />男
							</div>
							&nbsp;&nbsp;&nbsp;&nbsp;
							<div class="input-group-text">
								<input name="sex" type="radio" value="女" id="women" />女
							</div>
						</div>

						<div class="input-group  date ">
							<div class="input-group-prepend">
								<span class="input-group-text">出生日期</span>
							</div>
							<input id="birthday" name="birthday"
								class="form-control form_datetime removeC" size="40" type="text"
								readonly>
							<div class="input-group-append">
								<button
									class="btn btn-outline-secondary input-group-addon removeC	"
									type="button">
								<span class="fa  fa-calendar-times-o"></span>
								</button>
							</div>
						</div>
						<br>
						<div class="input-group mb-3">
							<div class="input-group-prepend">
								<span class="input-group-text">家庭地址</span>
							</div>
							<input class="form-control" id="address" type="text"
								name="address" maxlength="100">
						</div>

						<div class="input-group mb-3">
							<div class="input-group-prepend">
								<span class="input-group-text">部门名称</span>
							</div>
							<input id="dept" name="dept" class="form-control" size="40"
								type="text">
						</div>
						<div class="input-group mb-3">
							<div class="input-group-prepend">
								<span class="input-group-text">职务</span>
							</div>
							<input class="form-control" id="job" type="text" name="job" maxlength="20">
						</div>
						<div class="input-group mb-3">
							<div class="input-group-prepend">
								<span class="input-group-text">角色</span>
							</div>
							<select class="form-control" id="authority" name="roleid"></select>
						</div>
						<div class="input-group mb-3">
							<div class="input-group-prepend">
								<span class="input-group-text">联系电话</span>
							</div>
							<input class="form-control" id="tel" type="text" name="tel"
								oninput="value=value.replace(/[^\d]/g,'')" maxlength="11">
						</div>
						<div class="input-group">
							<div class="input-group-prepend">
								<span class="input-group-text">备注信息</span>
							</div>
							<textarea class="form-control" name="note" id="note" cols="25"
								rows="2" placeholder="请输入备注信息..." style="resize: none" maxlength="100"></textarea>
						</div>
						<br>
						<div class="enter">
							<input class="btn btn-primary btn-sm" type="button" onclick="up()"
								value="保存">&nbsp;&nbsp; <input
								class="btn btn-primary btn-sm" type="button" name="Submit"
								onclick="javascript:history.back(-1);" value="返回">
						</div>
					</fieldset>
				</form>
			</div>
		</div>
	</div>
	<div th:replace="fragment/public :: #public_footer"></div>
	<script src="../../../static/js/jquery-3.3.1.min.js"></script>
	<script src="../../../static/js/html.js"></script>
	<script src="../../../static/js/bootstrap.bundle.min.js"></script>
	<script src="../../../static/js/dataTables.bootstrap4.min.js"></script>
	<script src="../../../static/js/jquery.dataTables.min.js"></script>
	<!-- 时间选择器函数调用，主要调配置 -->
	<script type="text/javascript"
		src="../../../static/js/bootstrap-datetimepicker.min.js"
		charset="UTF-8"></script>
	<!-- 汉化时间选择器 -->
	<script type="text/javascript"
		src="../../../static/js/bootstrap-datetimepicker.zh-CN.js"
		charset="UTF-8"></script>
	<script>
		//实现角色默认选中动态下拉框 
		$(document).ready(
				function() {
					//获取当前角色
					let str;
					let id = window.location.search;
					id = id.slice(4);
					$.ajax({
						"url" : "/sysuser/selectSysuserId",
						"type" : "GET",
						"data" : {
							id : id
						},
						"dataType" : "json",
						"success" : function(data) {
							str = data.roleid;
							$("#sysuserid").val(data.sysuserid);
							$("#sysuserid").val(data.sysuserid);
							$("#usernum").val(data.usernum);
							$("#name").val(data.name);
							if (data.sex == "男") {
								$("#men").prop("checked", "checked");
							}
							if (data.sex == "女") {
								$("#women").prop("checked", "checked");
							}
							$("#birthday").val(data.birthday);
							$("#address").val(data.address);
							$("#dept").val(data.dept);
							$("#job").val(data.job);
							$("#tel").val(data.tel);
							$("#note").val(data.note);
							//生成角色下拉框
							$.ajax({
								"url" : "/role/selectRole",
								"type" : "GET",
								"data" : "",
								"dataType" : "json",
								"success" : function(data) {
									let list = (data.list)
									for (let i = 0; i < list.length; i++) {
										if (str == list[i].roleid) {
											$("#authority").prepend(
													"<option value="+list[i].roleid+" selected = 'selected'>"
															+ list[i].name
															+ "</option>");
											continue;
										}
										$("#authority").prepend(
												"<option value="+list[i].roleid+">"
														+ list[i].name + "</option>");
									}
								},
								"error" : function() {
									alert("角色信息出错");
								}
							});
						},
						"error" : function() {
							alert("角色信息出错");
						}
					});

					
					//时间控件
					$('.form_datetime').datetimepicker({
						format : 'yyyy-mm-dd',

						//语言选择中文
						language : 'zh-CN',
						//weekStart — 一周从哪一天开始
						weekStart : 1,
						//最多显示时间，天。默认小时为0
						minView : 2,
						todayBtn : 1,//关闭选择今天按钮
						//autoclose — 选完时间后是否自动关闭
						autoclose : 1,
						//— 当天日期高亮
						todayHighlight : 1,
						startView : 2,//打开弹出框时，显示到什么格式,3代表月
						//当选择器关闭的时候，是否强制解析输入框中的值。
						//也就是说，当用户在输入框中输入了不正确的日期，
						//选择器将会尽量解析输入的值，并将解析后的正确值按照给定的格式format设置到输入框中。
						forceParse : 0,
						//展示上午下午
						showMeridian : 1
					});
				});
		$(".removeC").click(function() {
			$('.form_datetime').val("");
		});
	</script>
	<script type="text/javascript">
		function up(){
			if(submit_check()== true){
				let form = $("#formup").serialize();
				 $.ajax({
					"url" : "/sysuser/updateSysuser",
					"type" : "POST",
					"data" : form,
					"dataType" : "json",
					"success" : function(data) {
						alert(data.status);
						if(data.status == "更改成功"){
							history.back();
						};
					},
					"error" : function() {
						alert("连接出错");
					}
				});
			}
			
		}
		// 唯一非空
		function usernum_uq_null() {
			var usernum = $("#usernum").val();
			var id = $("#sysuserid").val();
			var length = usernum.length;
			var r = "false";

			if (length == null || length == "" || length == undefined) {
				$("#usernumAlert").show();
				return r;
			} else {
				$("#usernumAlert").hide();
				r = "true";
			}

			$.ajax({
				"async" : false,
				"url" : "/sysuser/verifyUsernum",
				"data" : {
					"id" : id,
					"usernum" : usernum
				},
				"type" : "get",
				"dataType" : "json",
				"success" : function(data) {
					if (data.status == "200") {
						$("#usernumAlert").hide();
						r = "true";

					}
					if (data.status == "400") {
						$("#usernumAlert").show();
						r = "false";
					}
				},
				"error" : function() {
					alert("请求失败");
					r = "false";
				}
			});
			return r;
		}

		//限制字符非空
		function name_unnull() {
			var name = $("#name").val();
			var length = name.length;
			if (length == null || length == "" || length == undefined) {
				$("#nameAlert").show();
				return "false";
			} else {
				$("#nameAlert").hide();
				return "true";
			}
		}

		function submit_check() {
			var r = false;
			usernum_uq_null();
			name_unnull();
			if (usernum_uq_null() == "true" && name_unnull() == "true") {
				r = true;
			}
			return r;
		}
	</script>
	<script type="text/javascript">
		function resetting() {
			if (confirm("您确定要重置吗?")) {
				//alert("删除成功");
				//location.href = "../../../update_SimList";

				// 发AJAX请求，并处理结果
				var id = $("#sysuserid").val();
				$.ajax({
					"url" : "/sysuser/resetPass",
					"data" : {
						id : id
					},
					"type" : "post",
					"dataType" : "json",
					"success" : function() {
						alert("重置成功");
						location.reload();
					},
					"error" : function() {
						alert("请重新操作");
						location.reload();
					}
				});
			}
		}
	</script>
</body>
</html>