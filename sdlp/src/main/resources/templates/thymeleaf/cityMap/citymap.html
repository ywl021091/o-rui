<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8"/>
<title>地图</title>
<script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=TptRlDEacCRniB9GLU7hjEQXckOyS56u"></script>
<!-- bootstrap的css样式，大部分使用此命名 -->
<link rel="stylesheet" href="../../../static/css/bootstrap.min.css">
<link rel="stylesheet" href="../../../static/css/html.css">
<style type="text/css">
#center {
	width: 70%;
	height: auto;
}

#container {
	width: 100%;
	height: 100%;
	margin: 0;
	padding: 0;
}

#right {
	width: 15%;
	height: 70%;
	margin: 15px auto;
	padding: 20px;
	border: 1px #1E7ACE solid;
}

fieldset {
	padding: 10px;
	margin-top: 5px;
	border: 1px solid #1E7ACE;
	background: #fff;
}

fieldset legend {
	color: #1E7ACE;
	font-weight: bold;
	font-size: 20px;
	padding: 3px 20px 3px 20px;
	border: 1px solid #1E7ACE;
	background: #fff;
	padding: 3px 20px 3px 20px;
}

.enter {
	text-align: center;
}
</style>
</head>
<body>
	<div th:replace="fragment/public :: #public_header"></div>
	<div th:replace="fragment/public :: #public_time"></div>
	<div class="publicBody">
		<div th:replace="fragment/public :: #public_left"></div>
		<div id="center">
			<div id="container">
				<div id="allmap" style="width: 100%; height: 95%;"></div>
				<span id="result" th:text="${status}"></span>
			</div>
		</div>
		<div id="right">
			<form id="address_form">
				<fieldset>
					<legend>查询城市信息</legend>
					<div class="input-group mb-3">
						<div class="input-group-prepend">
							<span class="input-group-text">省份</span>
						</div>
						<select id="province" class="form-control" name="province"
							onchange="getCity(this)"></select>
					</div>
					<div class="input-group mb-3">
						<div class="input-group-prepend">
							<span class="input-group-text">城市</span>
						</div>
						<select class="form-control" id="city" name="city"></select>
					</div>
					<div class="enter">
						<input class="btn btn-primary btn-lg" type="button" value="查询"
							onclick="theLocation()" />
					</div>
				</fieldset>
			</form>
		</div>
	</div>
	<div th:replace="fragment/public :: #public_footer"></div>
	<script src="../../../static/js/jquery-3.3.1.min.js"></script>
	<script src="../../../static/js/html.js"></script>
<script src="../../../static/js/bootstrap.bundle.min.js"></script>
<script src="../../../static/js/cityArray.js"></script>
<script src="../../../static/js/cityMethod.js"></script>
<script type="text/javascript">
	//实例化浏览器定位对象。
	var geolocation = new BMap.Geolocation();
	//创建地图解析器
	var geoc = new BMap.Geocoder();
	// 编写自定义函数,创建标注添加坐标，和备注信息
	function addMarker(marker, label) {
		//给个坐标创建标注
		//var marker = new BMap.Marker(point);
		//map.addOverlay(marker);
		marker.setLabel(new BMap.Label(label, {
			offset : new BMap.Size(20, -10)
		}));
	}
	var map = new BMap.Map("allmap");
	function showMap(map) {
		//START显示自己的位置+备注信息
		map.enableScrollWheelZoom(true);//滚轮缩放地图
		//创建起始坐标
		var point = new BMap.Point(116.331398, 39.897445);
		//将起始坐标添加到地图上
		map.centerAndZoom(point, 9);
		//获取当前的地理位置
		//定位结果对象会传递给r变量
		geolocation.getCurrentPosition(function(r) {
			//如果检索成功，通过Geolocation类的getStatus()可以判断是否成功定位
			if (this.getStatus() == BMAP_STATUS_SUCCESS) {
				//获取r的经纬度
				var pt = r.point;
				var mk = new BMap.Marker(pt);
				//将经纬度 pt和备注获取并赋值给rs
				geoc.getLocation(pt, function(rs) {
					//利用rs获取具体定位信息
					var addComp = rs.addressComponents;
					addMarker(mk, "浏览器定位:" + addComp.province + ", "
							+ addComp.city);
				});
				//地图中心移动 
				//map.addOverlay(mk);
				//map.panTo(pt);
				document.getElementById("result").innerHTML = "定位成功!";
			} else {
				document.getElementById("result").innerHTML = "定位失败!失败原因："
						+ this.getStatus();
				//失败的话输出：失败原因+状态吗
				//alert('failed'+this.getStatus());
			}
			//enableHighAccuracy: true是否使用高精度
		}, {
			enableHighAccuracy : true
		})
	}
	//END显示自己的位置+备注信息
	showMap(map);
	//START查询功能
	//坐标转换完之后的回调函数
	// 百度地图API功能
	//点击事件
	function theLocation() {
		$('#allmap').remove();
		$('#container').append('<div id="allmap" style="width: 100%; height: 95%;"></div>');
		var map = new BMap.Map("allmap");
		document.getElementById("result").innerHTML = "正在获取位置信息....";
		showMap(map);
		var province = document.getElementById("province").value;

		var convertor = new BMap.Convertor();
		//获取输入的城市信息
		var city = document.getElementById("city").value;
		//alert(city);
		if (province != "" && city != "") {
			//添加到地图上
			map.centerAndZoom(province + city, 12);// 用城市名设置地图中心点
		}
		//isAddressEmpty(province, city);
		$
				.ajax({
					"url" : "query_longitude_latitude",
					"data" : $("#address_form").serialize(),
					"type" : "post",
					"dataType" : "json",
					"success" : function(datas) {
						var adds = new Array();
						for (var i = 0; i < datas.length; i++) {
							adds[i] = new BMap.Point(datas[i].longitude,
									datas[i].latitude);
							 
							//经纬度定位
							//var mk = new BMap.Marker(adds[i]);
							/* var a;
							if (datas[i].isuse == 0) {
								a = "启用";
							} else {
								a = "停用";
							} */
							//经纬度定位
							//bdGEO(adds[i], map, mk,data[i].num,a);
						}
						//GPS定位
						translateCallback = function(data) {
							if (data.status === 0) {
								for (var i = 0; i < data.points.length; i++) {
									var marker = new BMap.Marker(data.points[i]);
									bdGEO(data.points[i], map, marker,
											datas[i].devicenum,datas[i].note, datas[i].isuse);

									map.addOverlay(marker);
								}
							}
						}
						convertor.translate(adds, 1, 5, translateCallback);
					}
				});
	}
	//添加备注信息
	function bdGEO(point, map, mk, num,customername, isuse) {
		//获取每一个经纬度
		var pt = point;
		//将经纬度 pt和备注获取并赋值给rs
		geoc.getLocation(pt, function(rs) {
			//利用rs获取具体定位信息
			var addComp = rs.addressComponents;
			//addMarker(mk, addComp.province + ", " + addComp.city + ", "
			//		+ addComp.district + ", " + addComp.street + ", "
			//		+ addComp.streetNumber + '<br/>' + "设备编号:" + num + '<br/>'
			//		+ "启用状态:" + isuse);
			/* if(){
				
			}else{
				
			} */
			if(isuse == "启用"){
				addMarker(mk,'<span style="color:#F00">'+customername+'<br/>'+"设备编号:" + num +'&nbsp;&nbsp;'+"状态:" + isuse+'</span>');
			}else{
				addMarker(mk,'<span>'+customername+'<br/>'+"设备编号:" + num +'&nbsp;&nbsp;'+"状态:" + isuse+'</span>');
			}
			
			//alert(isuse);'<span style="color:#F00">'+customername+'<br/>'+"设备编号:" + num +'&nbsp;&nbsp;'+"状态:" + isuse+'</span>'
			         //addMarker(mk,customername+'<br/>'+"设备编号:" + num +'&nbsp;&nbsp;'+"状态:" + isuse);
			map.addOverlay(mk);
		});
	}
	//解析位置
	    $("#sbsbm").change(function(){
	    	theLocation();
    });
</script>
</body>
</html>
